---
title: Creating a Windows Stemcell for vSphere
owner: Windows
---

This topic describes how to create a BOSH stemcell for Pivotal Application Service (PAS) for Windows on VMware vSphere.

##<a id='overview'></a> Overview

Before you can deploy PAS for Windows on vSphere, you must create a BOSH stemcell for Windows, a versioned operating system image.
The BOSH stemcell that you create in this topic is based on Windows Server 2019.

To create a BOSH stemcell for Windows on vSphere, do the following:

1. [Create a Base VM for the BOSH Stemcell](#create-base-vm)
1. [Install Windows Updates](#install-windows-updates)
1. [Clone the Base VM](#clone-vm)
1. [Construct the BOSH Stemcell](#construct-stemcell)
1. [Package the BOSH Stemcell](#package-stemcell)

If you already have a BOSH stemcell for Windows on vSphere,
see [Next Steps](#patch-stemcell).

##<a id='prerequisites'></a> Prerequisites

* A vSphere environment
* A Windows Server 2019 ISO
* `stembuild` from a release in [Stemcells for PCF (Windows)](https://network.pivotal.io/products/stemcells-windows-server) on Pivotal Network that corresponds to the operating system of your local host and the stemcell version that you want to build
* Microsoft [Local Group Policy Object Utility (LGPO)](https://www.microsoft.com/en-us/download/details.aspx?id=55319) downloaded to the same folder as your `stembuild`

##<a id='create-base-vm'></a>Step 1: Create a Base VM for the BOSH Stemcell

This section describes how to create, configure, and verify a base VM for Windows
from a volume-licensed ISO.

###<a name='upload-windows-iso'></a>Upload the Windows Server 2019 ISO

To upload the Windows Server 2019 ISO to vSphere, do the following:

1. Log in to the vSphere Web Client.
  <p class="note"><strong>Note:</strong> The instructions in this topic are based on vSphere 6.0.</p>
1. Click **Storage** and select a datastore.
1. Select or create a folder where you want to upload the Windows Server 2019 ISO.
1. Click **Upload a File** and select the Windows Server 2019 ISO.

You can use the `scp` utility instead of the vSphere Web Client to copy the file directly to the datastore server.

###<a name='create-customize-vm'></a>Create and Customize a Base VM

To create and customize a base VM, do the following:

1. In the vSphere Web Client, click the **VMs and Templates** view to display the inventory objects.
1. Right-click an object and select **New Virtual Machine** > **New Virtual Machine**.
1. On the **Select a creation type** page, select **Create a new virtual machine** and click **Next**.
  <%= image_tag('new-vm.png') %>
1. On the **Select a name and folder** page, perform the following steps:
  1. Enter a name for the VM.
  1. Select a location for the VM.
  1. Click **Next**.
1. On the **Select a compute resource** page, select a compute resource to run the VM and click **Next**.
1. On the **Select storage** page, perform the following steps:
  1. Select a **VM Storage Policy**.
  1. Select the destination datastore for the VM configuration files and virtual disks.
  1. Click **Next**.
1. On the **Select compatibility** page, for the **Compatible with** configuration setting, select **ESXi 6.0 and later** and click **Next**.
1. On the **Select a guest OS** page, perform the following steps:
  1. For **Guest OS Family**, select **Windows**.
  1. For **Guest OS Version**, select **Microsoft Windows Server 2019**. If **Microsoft Windows Server 2019** is not
     available, select **Microsoft Windows Server 2016**.
  1. Click **Next**.
1. On the **Customize hardware** page, configure the VM hardware using the information below and click **Next**.
  1. For **New Hard disk**, specify 30 GB or greater.
  1. For **New CD\DVD Drive**, perform the following steps:
		1. Select **Datastore ISO File**.
		1. Select the Windows Server 2019 ISO file you uploaded to your datastore and click **OK**.
		1. Enable the **Connect At Power On** checkbox.
1. Review the configuration settings on the **Ready to complete** page and click **Finish**.

###<a name='install-windows-server'></a>Install Windows Server

To install Windows Server on the base VM, do the following:

1. After creating the VM, click **Power** > **Power On** in the **Actions** tab for your VM.
  <%= image_tag('power-on.png') %>
1. Select **Windows Server Standard**.
1. Select **Custom installation**.
1. Complete the installation process and enter a password for the Administrator user.

###<a name='verify-os'></a>Verify OS

To verify that you are using the correct the OS version, run the following PowerShell command on the base VM:

<pre><code>&#91;System.Environment&#93;::OSVersion.Version</code></pre>

The output should display the following:

<pre class="terminal">
&#91;System.Environment&#93;::OSVersion.Version
Major    Minor    Build    Revision
----     ----     -----    --------
10        0       17763    0
</pre>

###<a name='install-vmware-tools'></a>Install VMware Tools

To install VMware Tools on the base VM, do the following:

1. In the vSphere Web Client, right-click the base VM and select **Guest OS** > **Install VMware Tools**.
1. Navigate to the `D:` drive and run `setup64.exe`.
1. Restart the VM to complete the installation.

##<a id='install-windows-updates'></a>Step 2: Install Windows Updates

Install Windows updates on the base VM using your preferred procedure.
For example, you can install Windows updates by following the steps below.

1. On the base VM, run the **SConfig** utility.
1. Select **Download and Install Updates**.
1. Enter **A** to search for all updates.
1. For **Select an option**, enter **A** to install all updates.

You may need to restart the base VM while installing the updates.

##<a id='clone-vm'></a>Step 3: Clone the Base VM

To clone the base VM, do the following in the vSphere Web Client:

1. Power down the base VM.
1. Right-click the base VM.
1. Select **Clone** > **Clone to Virtual Machine**. This clone is your target VM.
  <%= image_tag('clone-vm.png') %>
1. Save the base VM. You will run Windows updates on this VM for future stemcells.

##<a id='construct-stemcell'></a>Step 4: Construct the BOSH Stemcell

Before constructing the BOSH stemcell, ensure that the target VM has an IP address and that
the target VM is routable from your local host.

To construct the BOSH stemcell, do the following:

1. Retrieve the IP address, username, and password for your target VM. Log out of the vSphere Web Client.

1. Run the following command from your local host:

    ```
    ./STEMBUILD-BINARY construct -winrm-ip 'TARGET-VM-IP' -winrm-username 'TARGET-USERNAME' -winrm-password 'TARGET-VM-PASSWORD'
    ```
    Where:
    * `STEMBUILD-BINARY` is the `stembuild` file for the version of your local host operating system and the
    version of the stemcell that you want to build. For example, `stembuild-windows-2019-2`.
    * `TARGET-VM-IP` is the IP address of your target VM.
    * `TARGET-USERNAME` is the username of an account with Administrator privileges.
    * `TARGET-VM-PASSWORD` is the password for the Administrator account. The password must be enclosed in single quotes.
  <p class='note'><strong>Note:</strong> During <code>construct</code> execution, the
WinRM connection may terminate. To view the status of <code>construct</code>, you must log in to the
target VM.</p>

This operation results in a powered-off Windows VM in your vSphere environment and may take up to an hour to complete.

##<a id='package-stemcell'></a>Step 5: Package the BOSH Stemcell

Before packaging the BOSH stemcell, collect the following information:

* vCenter inventory path in the `MY-DATA-CENTER/vm/MY-FOLDER/MY-VM` format where:
  * `MY-DATA-CENTER` is the name of the data center.
  * `vm` is a static string.
  * `MY-FOLDER` is the name of the folder that contains the VM.
  * `MY-VM` is the name of the target VM.
* vCenter username
* vCenter password
* vCenter URL

To package the BOSH stemcell, run the following command from your local host:

```
./STEMBUILD-BINARY package -vcenter-url 'VCENTER-URL' -vcenter-username 'VCENTER-USERNAME' -vcenter-password 'VCENTER-PASSWORD' -vm-inventory-path 'INVENTORY-PATH' -stemcell-version STEMCELL-VERSION -os OS-VERSION
```

Where:

* `STEMBUILD-BINARY` is the `stembuild` file for the version of your local host operating system and the
version of the stemcell that you want to build. For example, `stembuild-windows-2019-2`.
* `VCENTER-URL` is the URL of your vCenter.
* `VCENTER-USERNAME` is the username of your account in vCenter.
* `VCENTER-PASSWORD` is your password. The password must be enclosed in single quotes.
* `INVENTORY-PATH` is the vCenter inventory path to the target VM.
* `STEMCELL-VERSION` is the version of the stemcell that you want to build. For example, `2019.2`.
* `OS-VERSION` is the version of the operating system that you want to use for your stemcell. For example, `2019`.

This command creates a stemcell TAR file on your local host in the folder where you ran the command and may
take up to 30 minutes to complete.

##<a id='patch-stemcell'></a>Next Steps

After Microsoft releases operating system updates, you should patch your BOSH stemcell. Microsoft typically
releases Windows updates on the first Tuesday of each month.

To patch your BOSH stemcell, do the following:

1. [Install Windows Updates](#install-windows-updates) on the base VM.
1. [Clone the Base VM](#clone-vm).
1. [Construct the BOSH Stemcell](#construct-stemcell).
1. [Package the BOSH Stemcell](#package-stemcell).
1. Replace the existing stemcell in the Ops Manager stemcell library with this new stemcell.
1. Deploy the updated stemcell.
